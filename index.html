<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integra√ß√£o ChatBee √ó Oficina Inteligente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #028090;
            --secondary: #00A896;
            --accent: #02C39A;
            --dark: #1E2761;
            --text: #363636;
            --light-bg: #F5F5F5;
            --white: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--light-bg);
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--dark) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        header p {
            font-size: 1.2rem;
            color: var(--accent);
        }

        /* Navigation */
        nav {
            background: var(--white);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2rem;
        }

        nav a {
            color: var(--text);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }

        nav a:hover {
            color: var(--primary);
            background: var(--light-bg);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Sections */
        section {
            background: var(--white);
            margin: 2rem 0;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        section h2 {
            color: var(--dark);
            font-size: 2rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid var(--accent);
            display: inline-block;
        }

        section h3 {
            color: var(--primary);
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .card {
            background: var(--light-bg);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(2, 128, 144, 0.2);
        }

        .card h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .card p, .card ul {
            color: var(--text);
            font-size: 0.95rem;
        }

        /* Lists */
        ul.features-list {
            list-style: none;
            margin-top: 1rem;
        }

        ul.features-list li {
            padding: 0.8rem 0;
            padding-left: 2rem;
            position: relative;
            border-bottom: 1px solid #E0E0E0;
        }

        ul.features-list li:last-child {
            border-bottom: none;
        }

        ul.features-list li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: var(--accent);
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Numbered Steps */
        .steps {
            counter-reset: step-counter;
            list-style: none;
            margin-top: 1.5rem;
        }

        .steps li {
            counter-increment: step-counter;
            padding: 1rem 1rem 1rem 3.5rem;
            position: relative;
            margin-bottom: 1rem;
            background: var(--light-bg);
            border-radius: 8px;
        }

        .steps li:before {
            content: counter(step-counter);
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: var(--white);
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Code Blocks */
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            font-family: 'Courier New', monospace;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }

        th {
            background: var(--primary);
            color: var(--white);
            padding: 1rem;
            text-align: left;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #E0E0E0;
        }

        tr:hover {
            background: var(--light-bg);
        }

        /* Alert Boxes */
        .alert {
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid;
        }

        .alert-info {
            background: #E3F2FD;
            border-color: #2196F3;
            color: #0D47A1;
        }

        .alert-warning {
            background: #FFF3E0;
            border-color: #FF9800;
            color: #E65100;
        }

        .alert-success {
            background: #E8F5E9;
            border-color: #4CAF50;
            color: #1B5E20;
        }

        .alert strong {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        /* Flow Diagram */
        .flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 2rem 0;
        }

        .flow-item {
            background: var(--primary);
            color: var(--white);
            padding: 1.5rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            min-width: 150px;
        }

        .flow-arrow {
            color: var(--primary);
            font-size: 2rem;
            font-weight: bold;
        }

        /* Footer */
        footer {
            background: var(--dark);
            color: var(--white);
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            nav ul {
                flex-direction: column;
                gap: 0.5rem;
            }

            section {
                padding: 1.5rem;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .flow {
                flex-direction: column;
            }

            .flow-arrow {
                transform: rotate(90deg);
            }
        }

        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }

        /* Highlight */
        .highlight {
            background: linear-gradient(120deg, var(--accent) 0%, var(--accent) 100%);
            background-repeat: no-repeat;
            background-size: 100% 40%;
            background-position: 0 88%;
            padding: 0 0.2rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Integra√ß√£o ChatBee √ó Oficina Inteligente</h1>
        <p>Documenta√ß√£o T√©cnica e Regras de Neg√≥cio</p>
    </header>

    <nav>
        <ul>
            <li><a href="#visao-geral">Vis√£o Geral</a></li>
            <li><a href="#arquitetura">Arquitetura</a></li>
            <li><a href="#configuracao">Configura√ß√£o</a></li>
            <li><a href="#fluxos">Fluxos</a></li>
            <li><a href="#eventos">Eventos</a></li>
            <li><a href="#sincronizacao">Sincroniza√ß√£o</a></li>
            <li><a href="#testes">Testes</a></li>
        </ul>
    </nav>

    <div class="container">
        <!-- Vis√£o Geral -->
        <section id="visao-geral">
            <h2>Vis√£o Geral</h2>
            <p>Integra√ß√£o bidirecional entre a plataforma de atendimento <strong>ChatBee</strong> e o sistema de televendas <strong>Oficina Inteligente</strong>, permitindo sincroniza√ß√£o autom√°tica de atendimentos entre as plataformas.</p>
            
            <div class="cards-grid">
                <div class="card">
                    <h4>üéØ Objetivo</h4>
                    <p>Sincroniza√ß√£o autom√°tica de atendimentos, status e operadores entre as duas plataformas.</p>
                </div>
                <div class="card">
                    <h4>üè¢ Opera√ß√£o</h4>
                    <p>Suporte para empresa √∫nica ou rede de empresas (m√∫ltiplas companhias).</p>
                </div>
                <div class="card">
                    <h4>üîó Comunica√ß√£o</h4>
                    <p>Webhooks do ChatBee + API REST da Oficina Inteligente.</p>
                </div>
                <div class="card">
                    <h4>üß™ Ambiente de Testes</h4>
                    <p>Empresa 4000 (Companhia 288 - limita√ß√£o de acesso √† organiza√ß√£o no ChatBee).</p>
                </div>
            </div>
        </section>

        <!-- Arquitetura -->
        <section id="arquitetura">
            <h2>Arquitetura da Integra√ß√£o</h2>
            
            <div class="flow">
                <div class="flow-item">ChatBee</div>
                <div class="flow-arrow">‚Üí</div>
                <div class="flow-item">Webhook</div>
                <div class="flow-arrow">‚Üí</div>
                <div class="flow-item">Oficina Inteligente</div>
                <div class="flow-arrow">‚Üê</div>
                <div class="flow-item">API REST</div>
                <div class="flow-arrow">‚Üê</div>
                <div class="flow-item">ChatBee</div>
            </div>

            <ul class="features-list">
                <li>ChatBee envia eventos via webhook para Oficina Inteligente</li>
                <li>Oficina Inteligente processa eventos e atualiza televendas</li>
                <li>Oficina Inteligente envia atualiza√ß√µes via API para ChatBee</li>
                <li>Mapeamento De-Para entre entidades das plataformas</li>
                <li>Autentica√ß√£o via chave de API e headers customizados</li>
            </ul>
        </section>

        <!-- Configura√ß√£o -->
        <section id="configuracao">
            <h2>Configura√ß√£o</h2>

            <h3>üìã Oficina Inteligente</h3>
            <ol class="steps">
                <li>Definir c√≥digo da empresa (organiza√ß√£o e/ou companhia)</li>
                <li>Configurar pesquisa para classifica√ß√£o de origem do televendas</li>
                <li>Definir operador padr√£o para primeiro atendimento</li>
                <li>Configurar status de abertura + ID externo no ChatBee</li>
                <li>Configurar status de fechamento + ID externo no ChatBee</li>
                <li>Habilitar a integra√ß√£o</li>
                <li>Permitir altera√ß√£o de operador</li>
                <li>Colar chave de API do ChatBee</li>
            </ol>

            <h3>üìã ChatBee</h3>
            <ol class="steps">
                <li>Configurar c√≥digo da empresa no campo ID externo</li>
                <li>Habilitar recebimento de webhook</li>
                <li>Inserir URL de retorno (endpoint Oficina Inteligente)</li>
                <li>Informar n√∫mero de telefone para notifica√ß√µes de falha</li>
                <li>Criar header customizado: <code>x-cliente-id: WE-8E37AFD46C</code></li>
                <li>Gerar chave de acesso (informar na Oficina Inteligente)</li>
            </ol>

            <h3>üîÑ Mapeamento De-Para</h3>
            <table>
                <thead>
                    <tr>
                        <th>Oficina Inteligente</th>
                        <th>ChatBee</th>
                        <th>Campo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>PessoaID</td>
                        <td>Usu√°rio (contact.id)</td>
                        <td>external_id</td>
                    </tr>
                    <tr>
                        <td>Status ID</td>
                        <td>Status (payload.status.id)</td>
                        <td>external_id</td>
                    </tr>
                    <tr>
                        <td>Operador ID</td>
                        <td>Operador (user.id / operator.id)</td>
                        <td>external_id</td>
                    </tr>
                </tbody>
            </table>

            <div class="alert alert-info">
                <strong>Exemplo de Mapeamento:</strong>
                Status "Criar Televenda - Teste Dev" (ChatBee ID 2347) ‚Üí Status 6 (Oficina - Abertura)<br>
                Status "Convers√£o - Teste Dev" (ChatBee ID 2349) ‚Üí Status 8 (Oficina - Fechamento)
            </div>
        </section>

        <!-- Fluxos -->
        <section id="fluxos">
            <h2>Fluxos de Opera√ß√£o</h2>

            <h3>1Ô∏è‚É£ Cen√°rio: Primeira Mensagem do Cliente</h3>
            <div class="alert alert-info">
                <strong>Evento:</strong> ATTENDANCE_CREATED (sem status, sem operador)<br>
                <strong>A√ß√£o:</strong> Nenhuma a√ß√£o na Oficina Inteligente
            </div>
            <p>Cliente envia a primeira mensagem ‚Üí Chat criado no ChatBee ‚Üí Webhook enviado ‚Üí <strong>Nada acontece na Oficina</strong> (ainda n√£o h√° status ou operador).</p>

            <h3>2Ô∏è‚É£ Cen√°rio: Operador Inicia Atendimento</h3>
            <div class="alert alert-info">
                <strong>Evento:</strong> ATTENDANCE_CREATED (com operador, sem status)<br>
                <strong>A√ß√£o:</strong> Nenhuma a√ß√£o na Oficina Inteligente
            </div>
            <p>Operador envia primeira mensagem ao cliente ‚Üí Chat recebe operador ‚Üí Webhook enviado ‚Üí <strong>Nada acontece na Oficina</strong> (ainda n√£o h√° status classificado).</p>

            <h3>3Ô∏è‚É£ Cen√°rio: Cria√ß√£o de Televendas</h3>
            <div class="alert alert-success">
                <strong>Evento:</strong> STATUS_CHANGED (status de abertura)<br>
                <strong>A√ß√£o:</strong> <span class="highlight">CRIAR TELEVENDAS</span>
            </div>
            <p>Operador classifica atendimento com status de abertura ‚Üí Webhook enviado ‚Üí <strong>Televendas criado</strong> com operador padr√£o parametrizado.</p>

            <h3>4Ô∏è‚É£ Cen√°rio: Altera√ß√£o de Status</h3>
            <div class="alert alert-success">
                <strong>Evento:</strong> STATUS_CHANGED (qualquer status)<br>
                <strong>A√ß√£o:</strong> <span class="highlight">ATUALIZAR TELEVENDAS</span>
            </div>
            <p>Operador altera status do atendimento ‚Üí Webhook enviado ‚Üí <strong>Status do televendas atualizado</strong>.</p>

            <h3>5Ô∏è‚É£ Cen√°rio: Altera√ß√£o de Operador</h3>
            <div class="alert alert-success">
                <strong>Evento:</strong> OPERATOR_CHANGED<br>
                <strong>A√ß√£o:</strong> <span class="highlight">ATUALIZAR OPERADOR DO TELEVENDAS</span>
            </div>
            <p>Supervisor altera operador ‚Üí Webhook enviado ‚Üí <strong>Operador do televendas atualizado</strong> (se mapeado no De-Para).</p>

            <h3>6Ô∏è‚É£ Cen√°rio: Encerramento de Atendimento</h3>
            <div class="alert alert-success">
                <strong>Evento:</strong> ATTENDANCE_CLOSED (com status de fechamento)<br>
                <strong>A√ß√£o:</strong> <span class="highlight">ENCERRAR TELEVENDAS</span>
            </div>
            <p>Operador encerra atendimento com status de fechamento ‚Üí Webhook enviado ‚Üí <strong>Televendas encerrado</strong>.</p>
        </section>

        <!-- Eventos -->
        <section id="eventos">
            <h2>Eventos do ChatBee</h2>

            <div class="cards-grid">
                <div class="card">
                    <h4>ATTENDANCE_CREATED</h4>
                    <p>Disparado quando um atendimento √© criado (primeira mensagem do cliente ou primeira resposta do operador).</p>
                </div>
                <div class="card">
                    <h4>STATUS_CHANGED</h4>
                    <p>Disparado quando o status do atendimento √© alterado. <strong>Usado para criar e atualizar televendas</strong>.</p>
                </div>
                <div class="card">
                    <h4>OPERATOR_CHANGED</h4>
                    <p>Disparado quando o operador respons√°vel pelo atendimento √© alterado.</p>
                </div>
                <div class="card">
                    <h4>ATTENDANCE_CLOSED</h4>
                    <p>Disparado quando o atendimento √© encerrado no ChatBee.</p>
                </div>
            </div>

            <h3>üì¶ Estrutura do Webhook</h3>
            <pre><code>{
  "timestamp": "2026-02-02T16:52:47.528Z",
  "type": "STATUS_CHANGED",
  "organization": {
    "id": "255",
    "name": "Oficina Inteligente LTDA",
    "external_id": null
  },
  "company": {
    "id": "288",
    "name": "Oficina Inteligente",
    "external_id": "4000"  ‚Üê C√≥digo da empresa
  },
  "user": {
    "id": "5990",
    "name": "Igor",
    "external_id": "17264996"  ‚Üê ID do operador na Oficina
  },
  "history": {
    "id": "12129558",  ‚Üê ID do atendimento
    "channel_id": "2438",
    "is_out_of_office_hours": false,
    "automatic": false
  },
  "channel": {
    "id": "2438",
    "name": "Marketing - CS",
    "number": "5511967574497"
  },
  "contact": {
    "id": "7302314",
    "name": ".",
    "address": "554898457029",  ‚Üê Telefone do cliente
    "type": "wa",
    "external_id": null
  },
  "payload": {
    "status": {
      "id": "2347",
      "name": "Criar Televenda - Teste Dev",
      "external_id": "6"  ‚Üê Status na Oficina
    }
  }
}</code></pre>
        </section>

        <!-- Sincroniza√ß√£o -->
        <section id="sincronizacao">
            <h2>Regras de Sincroniza√ß√£o</h2>

            <h3>ChatBee ‚Üí Oficina Inteligente ‚úÖ</h3>
            <ul class="features-list">
                <li>Televendas criado apenas quando status de abertura √© classificado</li>
                <li>Altera√ß√£o de operador atualiza operador do televendas</li>
                <li>Altera√ß√£o de status atualiza status do televendas</li>
                <li>Status de fechamento encerra televendas</li>
            </ul>

            <h3>Oficina Inteligente ‚Üí ChatBee ‚ö†Ô∏è</h3>
            <ul class="features-list">
                <li>Altera√ß√£o de status ou operador √© enviada para ChatBee</li>
                <li>Atualiza√ß√£o n√£o ocorre se ID externo n√£o configurado no ChatBee</li>
                <li><strong>Status de fechamento N√ÉO encerra atendimento no ChatBee</strong></li>
                <li>Evento ATTENDANCE_CLOSED n√£o √© usado para encerrar no ChatBee</li>
            </ul>

            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Aten√ß√£o: Sincroniza√ß√£o Assim√©trica</strong>
                O encerramento funciona apenas no sentido ChatBee ‚Üí Oficina Inteligente. Encerrar um televendas na Oficina N√ÉO fecha o atendimento no ChatBee.
            </div>
        </section>

        <!-- Pontos de Aten√ß√£o -->
        <section id="pontos-atencao">
            <h2>Pontos de Aten√ß√£o</h2>

            <div class="cards-grid">
                <div class="card">
                    <h4>‚ö†Ô∏è Limita√ß√£o de Testes</h4>
                    <p>Ambiente atual usa apenas Companhia 4000 devido a restri√ß√µes de acesso.</p>
                </div>
                <div class="card">
                    <h4>‚ö†Ô∏è Cria√ß√£o Condicional</h4>
                    <p>Televendas s√≥ √© criado quando status de abertura √© classificado, n√£o na cria√ß√£o do atendimento.</p>
                </div>
                <div class="card">
                    <h4>‚ö†Ô∏è Operador Padr√£o</h4>
                    <p>Mesmo com operador no ChatBee, televendas usa operador padr√£o configurado.</p>
                </div>
                <div class="card">
                    <h4>‚ö†Ô∏è Fechamento Assim√©trico</h4>
                    <p>Fechamento n√£o funciona no sentido Oficina ‚Üí ChatBee.</p>
                </div>
                <div class="card">
                    <h4>‚ö†Ô∏è Depend√™ncia de Configura√ß√£o</h4>
                    <p>ID externo deve estar configurado para sincroniza√ß√£o funcionar.</p>
                </div>
                <div class="card">
                    <h4>‚ö†Ô∏è Mapeamento Obrigat√≥rio</h4>
                    <p>De-Para deve estar configurado para status, operadores e clientes.</p>
                </div>
            </div>
        </section>

        <!-- Testes -->
        <section id="testes">
            <h2>Cen√°rios de Teste BDD</h2>

            <h3>Checklist de Valida√ß√£o</h3>
            <table>
                <thead>
                    <tr>
                        <th>Cen√°rio</th>
                        <th>Evento</th>
                        <th>Resultado Esperado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Cliente envia primeira mensagem</td>
                        <td>ATTENDANCE_CREATED</td>
                        <td>Nenhuma a√ß√£o na Oficina</td>
                    </tr>
                    <tr>
                        <td>Operador atende</td>
                        <td>ATTENDANCE_CREATED</td>
                        <td>Nenhuma a√ß√£o na Oficina</td>
                    </tr>
                    <tr>
                        <td>Classificar status de abertura</td>
                        <td>STATUS_CHANGED</td>
                        <td>Criar televendas</td>
                    </tr>
                    <tr>
                        <td>Alterar status</td>
                        <td>STATUS_CHANGED</td>
                        <td>Atualizar televendas</td>
                    </tr>
                    <tr>
                        <td>Alterar operador</td>
                        <td>OPERATOR_CHANGED</td>
                        <td>Atualizar operador</td>
                    </tr>
                    <tr>
                        <td>Encerrar atendimento</td>
                        <td>ATTENDANCE_CLOSED</td>
                        <td>Encerrar televendas</td>
                    </tr>
                    <tr>
                        <td>Alterar status na Oficina</td>
                        <td>API Call</td>
                        <td>Sincronizar para ChatBee</td>
                    </tr>
                    <tr>
                        <td>Encerrar na Oficina</td>
                        <td>-</td>
                        <td>N√ÉO encerra no ChatBee</td>
                    </tr>
                </tbody>
            </table>

            <h3>üìã Cen√°rios BDD Completos em Gherkin</h3>

            <h4>Feature 1: Configura√ß√£o Inicial</h4>
            <pre><code>Funcionalidade: Configurar par√¢metros da integra√ß√£o no sistema Oficina Inteligente
  Como administrador do sistema
  Eu quero configurar os par√¢metros de integra√ß√£o com ChatBee
  Para que os atendimentos sejam sincronizados corretamente

Cen√°rio: Configurar empresa e par√¢metros b√°sicos
  Dado que estou na tela de configura√ß√£o de integra√ß√£o
  Quando eu informo o c√≥digo da empresa "4000"
  E defino a pesquisa de classifica√ß√£o de origem
  E defino o operador padr√£o "Operador Teste"
  E defino o status de abertura "6"
  E defino o status de fechamento "8"
  E habilito a integra√ß√£o
  E permito altera√ß√£o de operador
  E informo a chave de API "WE-8E37AFD46C"
  Ent√£o a configura√ß√£o deve ser salva com sucesso
  E o sistema deve estar pronto para receber webhooks

Cen√°rio: Validar campos obrigat√≥rios
  Dado que estou na tela de configura√ß√£o de integra√ß√£o
  Quando eu tento salvar sem informar a chave de API
  Ent√£o devo ver a mensagem "Chave de API √© obrigat√≥ria"
  E a configura√ß√£o n√£o deve ser salva

Cen√°rio: Configurar webhook no ChatBee
  Dado que estou na tela de configura√ß√£o da empresa "288"
  Quando eu informo o ID externo "4000"
  E habilito o recebimento de webhook
  E informo a URL de retorno "https://api.oficinainteligente.com/webhook/chatbee"
  E informo o telefone de notifica√ß√£o "5511967574497"
  E crio o header "x-cliente-id" com valor "WE-8E37AFD46C"
  E gero a chave de acesso
  Ent√£o a configura√ß√£o deve ser salva com sucesso
  E o sistema deve enviar webhooks para a URL configurada</code></pre>

            <h4>Feature 2: Primeira Mensagem do Cliente</h4>
            <pre><code>Funcionalidade: Cliente envia primeira mensagem
  Como cliente
  Eu quero enviar uma mensagem no WhatsApp
  Para iniciar um atendimento

Cen√°rio: Cliente envia primeira mensagem - Nenhuma a√ß√£o na Oficina
  Dado que o cliente "5511948255689" nunca conversou com a empresa
  Quando o cliente envia a mensagem "Ol√°, preciso de ajuda"
  Ent√£o o ChatBee deve criar um atendimento com ID "12128782"
  E o atendimento n√£o deve ter operador atribu√≠do
  E o atendimento n√£o deve ter status classificado
  E o webhook "ATTENDANCE_CREATED" deve ser enviado para Oficina Inteligente
  E o webhook deve conter:
    """
    {
      "type": "ATTENDANCE_CREATED",
      "company": {"id": "288", "external_id": "4000"},
      "contact": {"id": "7302321", "address": "5511948255689"},
      "user": null
    }
    """
  E nenhum televendas deve ser criado na Oficina Inteligente
  E o log deve registrar "Atendimento sem status - aguardando classifica√ß√£o"</code></pre>

            <h4>Feature 3: Operador Inicia Atendimento</h4>
            <pre><code>Funcionalidade: Operador inicia atendimento
  Como operador do ChatBee
  Eu quero atender um cliente
  Para ajud√°-lo com sua solicita√ß√£o

Cen√°rio: Operador atende cliente - Ainda sem criar televendas
  Dado que existe um atendimento ID "12129558" sem operador
  E o atendimento n√£o tem status classificado
  Quando o operador "Igor" (ID 5990) envia a primeira mensagem
  Ent√£o o atendimento deve ser atribu√≠do ao operador
  E o webhook "ATTENDANCE_CREATED" deve ser enviado
  E o webhook deve conter dados do operador:
    """
    {
      "type": "ATTENDANCE_CREATED",
      "user": {"id": "5990", "name": "Igor", "external_id": "17264996"}
    }
    """
  E o atendimento ainda n√£o deve ter status classificado
  E nenhum televendas deve ser criado na Oficina Inteligente
  E o log deve registrar "Operador atribu√≠do - aguardando classifica√ß√£o de status"</code></pre>

            <h4>Feature 4: Criar Televendas (Status de Abertura)</h4>
            <pre><code>Funcionalidade: Criar televendas ao classificar status de abertura
  Como operador do ChatBee
  Eu quero classificar o atendimento com status de abertura
  Para criar um televendas na Oficina Inteligente

Contexto:
  Dado que a integra√ß√£o est√° configurada
  E o status "Criar Televenda - Teste Dev" (ID 2347) est√° mapeado com external_id "6"
  E o status "6" est√° configurado como status de abertura na Oficina Inteligente
  E o operador padr√£o "Operador Teste" est√° configurado

Cen√°rio: Criar televendas com sucesso
  Dado que existe um atendimento ID "12129558" com operador "Igor"
  E o atendimento n√£o tem status classificado
  E n√£o existe televendas vinculado ao atendimento
  Quando o operador classifica o atendimento com status "Criar Televenda - Teste Dev"
  Ent√£o o webhook "STATUS_CHANGED" deve ser enviado para Oficina Inteligente
  E o webhook deve conter:
    """
    {
      "type": "STATUS_CHANGED",
      "history": {"id": "12129558"},
      "payload": {
        "status": {"id": "2347", "external_id": "6"}
      }
    }
    """
  E um televendas deve ser criado na Oficina Inteligente
  E o televendas deve ter os seguintes dados:
    | Campo           | Valor                      |
    | Status          | 6 (abertura)               |
    | Operador        | Operador Teste (padr√£o)    |
    | History ID      | 12129558                   |
    | Cliente         | Contact ID 7302314         |
  E o log deve registrar "Televendas criado com sucesso - ID: [TELEVENDAS_ID]"
  E uma resposta HTTP 200 deve ser retornada ao ChatBee

Cen√°rio: Tentativa de criar televendas com status n√£o mapeado
  Dado que existe um atendimento ID "12129558"
  E o operador classifica com um status sem external_id configurado
  Quando o webhook "STATUS_CHANGED" √© recebido
  Ent√£o nenhum televendas deve ser criado
  E o log deve registrar "Status sem mapeamento - external_id n√£o encontrado"
  E uma resposta HTTP 200 deve ser retornada (n√£o bloqueia o processo)

Cen√°rio: Duplicidade - Atendimento j√° tem televendas
  Dado que existe um televendas ID "12345" vinculado ao history_id "12129558"
  Quando o webhook "STATUS_CHANGED" √© recebido novamente para o mesmo history_id
  Ent√£o nenhum televendas duplicado deve ser criado
  E o televendas existente "12345" deve ser atualizado
  E o log deve registrar "Televendas j√° existe - atualizando ao inv√©s de criar"</code></pre>

            <h4>Feature 5: Alterar Status do Atendimento</h4>
            <pre><code>Funcionalidade: Atualizar status do televendas
  Como operador do ChatBee
  Eu quero alterar o status do atendimento
  Para atualizar o televendas correspondente

Cen√°rio: Alterar status de atendimento em andamento
  Dado que existe um televendas ID "12345" vinculado ao atendimento "12129558"
  E o televendas tem status "6" (abertura)
  E existe um status "Em Negocia√ß√£o" com external_id "7" mapeado
  Quando o operador altera o status do atendimento para "Em Negocia√ß√£o"
  Ent√£o o webhook "STATUS_CHANGED" deve ser enviado
  E o televendas "12345" deve ser atualizado para status "7"
  E nenhum novo televendas deve ser criado
  E o hist√≥rico do televendas deve registrar a altera√ß√£o de status
  E o log deve registrar "Status atualizado: 6 ‚Üí 7"

Cen√°rio: Alterar para status n√£o mapeado
  Dado que existe um televendas ID "12345" vinculado ao atendimento "12129558"
  Quando o operador altera para um status que n√£o tem external_id configurado
  Ent√£o o webhook "STATUS_CHANGED" deve ser enviado
  E o televendas N√ÉO deve ser atualizado
  E o status atual deve ser mantido
  E o log deve registrar "Status sem mapeamento - ignorando atualiza√ß√£o"
  E uma resposta HTTP 200 deve ser retornada

Cen√°rio: Alterar status m√∫ltiplas vezes em sequ√™ncia
  Dado que existe um televendas ID "12345" com status "6"
  Quando o operador altera o status para "7"
  E em seguida altera para "8"
  E em seguida altera para "6" novamente
  Ent√£o todas as altera√ß√µes devem ser processadas em ordem
  E o status final deve ser "6"
  E o hist√≥rico deve conter todas as 3 altera√ß√µes</code></pre>

            <h4>Feature 6: Alterar Operador do Atendimento</h4>
            <pre><code>Funcionalidade: Atualizar operador do televendas
  Como supervisor
  Eu quero alterar o operador respons√°vel pelo atendimento
  Para redistribuir a carga de trabalho

Cen√°rio: Alterar operador de atendimento com televendas criado
  Dado que existe um televendas ID "12345" com operador "Igor" (external_id "17264996")
  E o atendimento ChatBee √© "12129558"
  E existe o operador "Elayne Oliveira" (external_id "17264997") no De-Para
  Quando o supervisor altera o operador para "Elayne Oliveira" no ChatBee
  Ent√£o o webhook "OPERATOR_CHANGED" deve ser enviado
  E o webhook deve conter:
    """
    {
      "type": "OPERATOR_CHANGED",
      "history": {"id": "12129558"},
      "payload": {
        "operator": {"id": "5743", "external_id": "17264997"}
      }
    }
    """
  E o televendas "12345" deve ser atualizado com operador "17264997"
  E o hist√≥rico deve registrar "Operador alterado: 17264996 ‚Üí 17264997"
  E o log deve registrar "Operador atualizado com sucesso"

Cen√°rio: Alterar para operador n√£o mapeado
  Dado que existe um televendas ID "12345"
  Quando o operador √© alterado para um que n√£o tem external_id configurado
  Ent√£o o webhook "OPERATOR_CHANGED" deve ser enviado
  E o televendas N√ÉO deve ser atualizado
  E o operador atual deve ser mantido
  E o log deve registrar "Operador sem mapeamento no De-Para"

Cen√°rio: Alterar operador antes de criar televendas
  Dado que existe um atendimento "12129558" sem status de abertura classificado
  E n√£o existe televendas vinculado
  Quando o operador √© alterado
  Ent√£o o webhook "OPERATOR_CHANGED" deve ser enviado
  E nenhuma a√ß√£o deve ocorrer na Oficina Inteligente
  E nenhum televendas deve ser criado
  E o log deve registrar "Nenhum televendas encontrado - ignorando altera√ß√£o de operador"</code></pre>

            <h4>Feature 7: Encerrar Atendimento</h4>
            <pre><code>Funcionalidade: Encerrar televendas quando atendimento √© fechado
  Como operador
  Eu quero encerrar o atendimento no ChatBee
  Para finalizar o televendas correspondente

Cen√°rio: Encerrar atendimento com status de fechamento mapeado
  Dado que existe um televendas ID "12345" em aberto
  E o atendimento ChatBee √© "12129558"
  E o status "Convers√£o - Teste Dev" (ID 2349) tem external_id "8"
  E o status "8" est√° configurado como status de fechamento na Oficina
  Quando o operador encerra o atendimento com status "Convers√£o - Teste Dev"
  Ent√£o o webhook "ATTENDANCE_CLOSED" deve ser enviado
  E o webhook deve conter:
    """
    {
      "type": "ATTENDANCE_CLOSED",
      "history": {"id": "12129558"},
      "payload": {
        "status": {"id": "2349", "external_id": "8"}
      }
    }
    """
  E o televendas "12345" deve ser encerrado
  E o status final deve ser "8"
  E a data de encerramento deve ser registrada
  E o log deve registrar "Televendas encerrado com sucesso"

Cen√°rio: Encerrar atendimento sem status de fechamento configurado
  Dado que existe um televendas ID "12345" em aberto
  Quando o operador encerra o atendimento com status n√£o mapeado como fechamento
  Ent√£o o webhook "ATTENDANCE_CLOSED" deve ser enviado
  E o televendas deve ser atualizado com o status recebido (se mapeado)
  E o televendas deve ser marcado como encerrado
  E o log deve registrar "Atendimento encerrado sem status de fechamento espec√≠fico"

Cen√°rio: Tentar encerrar atendimento sem televendas
  Dado que existe um atendimento "12129558" sem televendas criado
  Quando o operador encerra o atendimento
  Ent√£o o webhook "ATTENDANCE_CLOSED" deve ser enviado
  E nenhuma a√ß√£o deve ocorrer na Oficina Inteligente
  E o log deve registrar "Nenhum televendas encontrado para encerramento"
  E uma resposta HTTP 200 deve ser retornada</code></pre>

            <h4>Feature 8: Sincroniza√ß√£o Reversa (Oficina ‚Üí ChatBee)</h4>
            <pre><code>Funcionalidade: Sincronizar altera√ß√µes da Oficina para ChatBee
  Como operador da Oficina Inteligente
  Eu quero atualizar status e operador do televendas
  Para que sejam refletidos no ChatBee

Cen√°rio: Alterar status do televendas na Oficina
  Dado que existe um televendas ID "12345" vinculado ao atendimento ChatBee "12129558"
  E o televendas tem status "6"
  E existe mapeamento De-Para para status "7" no ChatBee
  E o status ChatBee correspondente tem ID externo configurado
  Quando o operador altera o status para "7" na Oficina Inteligente
  Ent√£o a Oficina deve enviar requisi√ß√£o PUT para API ChatBee
  E a requisi√ß√£o deve conter:
    """
    {
      "history_id": "12129558",
      "status_id": "[STATUS_CHATBEE_ID_MAPEADO]"
    }
    """
  E o atendimento "12129558" deve ser atualizado no ChatBee
  E o status deve ser sincronizado
  E o log deve registrar "Status sincronizado com ChatBee com sucesso"

Cen√°rio: Alterar operador do televendas na Oficina
  Dado que existe um televendas ID "12345" com operador "17264996"
  E o atendimento ChatBee √© "12129558"
  E existe mapeamento para operador "17264997" no ChatBee
  Quando o operador √© alterado para "17264997" na Oficina
  Ent√£o a Oficina deve enviar requisi√ß√£o PUT para API ChatBee
  E o operador do atendimento deve ser atualizado no ChatBee
  E o log deve registrar "Operador sincronizado com ChatBee"

Cen√°rio: Alterar para status sem ID externo no ChatBee
  Dado que existe um televendas ID "12345"
  E o status destino n√£o tem ID externo configurado no ChatBee
  Quando o operador tenta alterar o status na Oficina
  Ent√£o o status deve ser alterado localmente na Oficina
  E NENHUMA requisi√ß√£o deve ser enviada ao ChatBee
  E o log deve registrar "Status sem ID externo - n√£o sincronizado com ChatBee"

Cen√°rio: Encerrar televendas na Oficina (N√ÉO encerra no ChatBee)
  Dado que existe um televendas ID "12345" vinculado ao atendimento "12129558"
  E o status "8" est√° configurado como fechamento na Oficina
  Quando o operador altera para status "8" na Oficina
  Ent√£o o televendas deve ser encerrado na Oficina
  E NENHUM encerramento deve ser enviado ao ChatBee
  E o atendimento deve permanecer aberto no ChatBee
  E o log deve registrar "Fechamento n√£o sincronizado - regra de neg√≥cio"

Cen√°rio: Falha na sincroniza√ß√£o com ChatBee (retry)
  Dado que existe um televendas ID "12345"
  E vou alterar o status na Oficina
  Quando a API do ChatBee retorna erro 500
  Ent√£o o status deve ser alterado localmente
  E deve marcar como "pendente de sincroniza√ß√£o"
  E deve agendar retry ap√≥s 5 minutos
  E deve tentar no m√°ximo 3 vezes
  E o log deve registrar "Erro na sincroniza√ß√£o - agendado retry"</code></pre>

            <h4>Feature 9: Valida√ß√µes e Tratamento de Erros</h4>
            <pre><code>Funcionalidade: Validar dados e tratar erros
  Como sistema integrado
  Eu quero validar dados e tratar erros adequadamente
  Para garantir integridade da integra√ß√£o

Cen√°rio: Webhook sem external_id da empresa
  Dado que recebo um webhook do ChatBee
  E o campo company.external_id √© null ou vazio
  Quando o webhook √© processado
  Ent√£o deve rejeitar com HTTP 400
  E deve retornar mensagem "C√≥digo da empresa n√£o configurado"
  E nenhum televendas deve ser criado
  E deve enviar notifica√ß√£o para telefone configurado "5511967574497"

Cen√°rio: Webhook com empresa n√£o cadastrada
  Dado que recebo um webhook com company.external_id "9999"
  E a empresa "9999" n√£o existe na Oficina Inteligente
  Quando o webhook √© processado
  Ent√£o deve rejeitar com HTTP 404
  E deve retornar mensagem "Empresa n√£o encontrada: 9999"
  E deve registrar log de erro

Cen√°rio: Webhook com estrutura inv√°lida
  Dado que recebo um webhook malformado sem campo "type"
  Quando o webhook √© processado
  Ent√£o deve rejeitar com HTTP 400
  E deve retornar mensagem "Estrutura de webhook inv√°lida: campo 'type' ausente"
  E deve registrar a estrutura recebida no log

Cen√°rio: Autentica√ß√£o falha (header inv√°lido)
  Dado que recebo um webhook do ChatBee
  E o header "x-cliente-id" √© "INVALID-KEY"
  Quando o webhook √© processado
  Ent√£o deve rejeitar com HTTP 401 Unauthorized
  E deve retornar mensagem "Chave de autentica√ß√£o inv√°lida"
  E deve registrar tentativa de acesso n√£o autorizado
  E nenhum dado deve ser processado

Cen√°rio: Webhook duplicado (idempot√™ncia)
  Dado que processei o webhook com history.id "12129558" √†s "2026-02-02T16:52:47.528Z"
  E criei o televendas ID "12345"
  Quando recebo o mesmo webhook novamente (mesmos dados)
  Ent√£o deve identificar como duplicado
  E deve retornar HTTP 200 OK
  E N√ÉO deve criar novo televendas
  E deve retornar "Webhook j√° processado - televendas: 12345"
  E o log deve registrar "Webhook duplicado - ignorado"

Cen√°rio: Timeout na comunica√ß√£o com ChatBee
  Dado que a Oficina est√° enviando atualiza√ß√£o para ChatBee
  E a API ChatBee n√£o responde em 30 segundos
  Quando o timeout √© atingido
  Ent√£o deve cancelar a requisi√ß√£o
  E deve registrar falha no log "Timeout na API ChatBee"
  E deve marcar sincroniza√ß√£o como pendente
  E deve agendar retry ap√≥s 5 minutos

Cen√°rio: Validar mapeamento antes de criar televendas
  Dado que vou criar um televendas
  E o status do webhook tem external_id "99" (n√£o existe no De-Para)
  Quando tento processar o webhook
  Ent√£o deve rejeitar com HTTP 400
  E deve retornar mensagem "Status n√£o mapeado: external_id=99"
  E deve sugerir "Configure o mapeamento De-Para na administra√ß√£o"
  E nenhum televendas deve ser criado</code></pre>

            <h4>Feature 10: Massa de Dados e Integra√ß√£o Completa</h4>
            <pre><code>Funcionalidade: Teste de integra√ß√£o end-to-end
  Como QA
  Eu quero validar o fluxo completo da integra√ß√£o
  Para garantir que todos os componentes funcionam juntos

Cen√°rio: Fluxo completo - Do primeiro contato ao fechamento
  Dado que a integra√ß√£o est√° configurada
  E o cliente "5511948255689" est√° cadastrado
  
  # Passo 1: Cliente envia mensagem
  Quando o cliente envia "Ol√°, preciso de or√ßamento"
  Ent√£o atendimento "12128782" √© criado no ChatBee
  E nenhum televendas √© criado (sem status)
  
  # Passo 2: Operador atende
  Quando operador "Igor" responde "Ol√°! Como posso ajudar?"
  Ent√£o operador √© atribu√≠do ao atendimento
  E ainda nenhum televendas √© criado (sem status)
  
  # Passo 3: Classifica√ß√£o de abertura
  Quando operador classifica com status "Criar Televenda - Teste Dev"
  Ent√£o televendas "TV-001" √© criado
  E operador do televendas √© "Operador Teste" (padr√£o)
  E status do televendas √© "6" (abertura)
  
  # Passo 4: Altera√ß√£o de status
  Quando operador altera status para "Em Negocia√ß√£o" (external_id "7")
  Ent√£o televendas "TV-001" √© atualizado para status "7"
  
  # Passo 5: Troca de operador
  Quando supervisor altera operador para "Elayne Oliveira"
  Ent√£o televendas "TV-001" √© atualizado para operador "17264997"
  
  # Passo 6: Altera√ß√£o na Oficina
  Quando na Oficina altero status para "Proposta Enviada" (external_id "9")
  Ent√£o atendimento no ChatBee √© atualizado para status "Proposta Enviada"
  
  # Passo 7: Encerramento
  Quando operador encerra atendimento com status "Convers√£o - Teste Dev"
  Ent√£o televendas "TV-001" √© encerrado
  E status final √© "8" (fechamento)
  E data de encerramento √© registrada

Cen√°rio: Teste de carga - M√∫ltiplos webhooks simult√¢neos
  Dado que a integra√ß√£o est√° configurada
  Quando recebo 50 webhooks STATUS_CHANGED simultaneamente
  E cada webhook √© de um atendimento diferente
  Ent√£o todos os 50 televendas devem ser criados
  E nenhum televendas duplicado deve existir
  E todos os webhooks devem retornar HTTP 200
  E tempo de resposta m√©dio deve ser < 2 segundos
  E todos os logs devem estar consistentes</code></pre>

            <h3>Valida√ß√µes de Erro</h3>
            <ul class="features-list">
                <li>Webhook sem company.external_id ‚Üí HTTP 400</li>
                <li>Empresa n√£o cadastrada ‚Üí HTTP 404</li>
                <li>Webhook duplicado (idempot√™ncia) ‚Üí HTTP 200 (ignorar)</li>
                <li>Estrutura de webhook inv√°lida ‚Üí HTTP 400</li>
                <li>Autentica√ß√£o falha (header x-cliente-id inv√°lido) ‚Üí HTTP 401</li>
                <li>Timeout na comunica√ß√£o com API ‚Üí Retry 3x</li>
                <li>Status n√£o mapeado no De-Para ‚Üí HTTP 400</li>
                <li>Operador n√£o mapeado no De-Para ‚Üí HTTP 200 (warning)</li>
                <li>Cliente/contato n√£o encontrado ‚Üí Criar automaticamente</li>
            </ul>

            <div class="alert alert-success">
                <strong>‚úÖ Cobertura Completa</strong>
                Total de <strong>30+ cen√°rios BDD</strong> cobrindo todos os fluxos, valida√ß√µes e tratamentos de erro da integra√ß√£o.
            </div>
        </section>

        <!-- Massa de Dados -->
        <section id="massa-dados">
            <h2>Massa de Dados de Teste</h2>

            <h3>üè¢ Empresas</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>External ID</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Organiza√ß√£o</td>
                        <td>255</td>
                        <td>Oficina Inteligente LTDA</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>Companhia</td>
                        <td>288</td>
                        <td>Oficina Inteligente</td>
                        <td>4000</td>
                    </tr>
                </tbody>
            </table>

            <h3>üë§ Usu√°rios/Operadores</h3>
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>ChatBee ID</th>
                        <th>External ID (Oficina)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Igor</td>
                        <td>5990</td>
                        <td>17264996</td>
                    </tr>
                    <tr>
                        <td>Elayne Oliveira</td>
                        <td>5743</td>
                        <td>17264997</td>
                    </tr>
                </tbody>
            </table>

            <h3>üìä Status</h3>
            <table>
                <thead>
                    <tr>
                        <th>ChatBee</th>
                        <th>External ID</th>
                        <th>Oficina Inteligente</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ID 2347: "Criar Televenda - Teste Dev"</td>
                        <td>6</td>
                        <td>Status 6 (Abertura)</td>
                    </tr>
                    <tr>
                        <td>ID 2349: "Convers√£o - Teste Dev"</td>
                        <td>8</td>
                        <td>Status 8 (Fechamento)</td>
                    </tr>
                </tbody>
            </table>

            <h3>üìû Contatos/Clientes</h3>
            <table>
                <thead>
                    <tr>
                        <th>Contact ID</th>
                        <th>Nome</th>
                        <th>Telefone (Address)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>7302314</td>
                        <td>.</td>
                        <td>554898457029</td>
                    </tr>
                    <tr>
                        <td>7302321</td>
                        <td>Igor</td>
                        <td>5511948255689</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </div>

    <footer>
        <p>&copy; 2026 - Integra√ß√£o ChatBee √ó Oficina Inteligente</p>
        <p>Documenta√ß√£o T√©cnica - Vers√£o 1.0</p>
    </footer>

    <script>
        // Smooth scroll para navega√ß√£o
        document.querySelectorAll('nav a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });

        // Highlight ativo no menu
        window.addEventListener('scroll', () => {
            let current = '';
            document.querySelectorAll('section').forEach(section => {
                const sectionTop = section.offsetTop;
                if (window.pageYOffset >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').substring(1) === current) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>